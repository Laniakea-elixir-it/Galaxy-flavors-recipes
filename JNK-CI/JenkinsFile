pipeline {
	agent any
		options { disableConcurrentBuilds() }
	stages {
		stage('Shell script 0') {
			steps {
				withCredentials([file(credentialsId: 'galaxy_it_credentials_mtangaro_general_user', variable: 'OPESTACK_CREDENTIALS')]) {
					sh '''
						set +x $OPENSTACK_CREDENTIALS
						.  $OPESTACK_CREDENTIALS
						git clone https://github.com/Laniakea-elixir-it/TerraFormExpress.git 
						cd TerraFormExpress 
						terraform init
						terraform apply -auto-approve -var="image_name=$IMAGE"
						export VM_IP=$(terraform output -raw public_ip)
						echo $VM_IP
						cd ..
							git clone https://github.com/Laniakea-elixir-it/ansible-role-laniakea-galaxy-tools.git
								cd ansible-role-laniakea-galaxy-tools && git checkout dev && cd ..  
								git clone https://github.com/pmandreoli/Galaxy-flavors-recipes.git
								cd Galaxy-flavors-recipes && cd JNK-CI
								sed -i s/VM_IP/$VM_IP/g hosts
								ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -i hosts --private-key /home/centos/.ssh/id_rsa  tools_playbook.yml -e galaxy_flavor=$FLAVOR -e galaxy_flavor_version=$VERSION
								ansible-playbook -i hosts --private-key /home/centos/.ssh/id_rsa  dump.yml -e ansible_python_interpreter=/usr/bin/python -e galaxy_flavor=$FLAVOR -e galaxy_flavor_version=$VERSION '''
				}

			}
		}
		stage('upload to swift'){
			steps {

				withCredentials([file(credentialsId: 'galaxy_it_credentials_mtangaro_general_user', variable: 'OPENSTACK_CREDENTIALS')]) {
					sh '''
						cd Galaxy-flavors-recipes/JNK-CI
						cat $OPENSTACK_CREDENTIALS > rc.sh
						ansible-playbook -i hosts --private-key /home/centos/.ssh/id_rsa  swift_upload.yml '''
				}


			}
		}
		stage('delete vm'){
			steps {
				withCredentials([file(credentialsId: 'galaxy_it_credentials_mtangaro_general_user', variable: 'OPENSTACK_CREDENTIALS')]) {
					sh '''
						set +x $OPENSTACK_CREDENTIALS
						.  $OPENSTACK_CREDENTIALS
						cd TerraFormExpress
						terraform destroy -auto-approve -var="image_name=$IMAGE" '''
				}

			}
		}
	}
	post { 
		always { 
			cleanWs()
		}
	}
}



